---
params:
    root_directory: NULL
    input_seurat_object: NULL
    output_seurat_object: NULL
title: "NBIS Support #5568"
subtitle: "Integration and differential expression"
author: "Erik Fasterius"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
html_document:
    code_folding: hide
    toc: true
    toc_float:
        collapsed: true
---

```{r Setup}
# Knit options
knitr::opts_knit$set(root.dir = params$root_directory)

# Chunk options
knitr::opts_chunk$set(fig.width  = 12,
                      fig.height = 8,
                      fig.align  = "center",
                      message    = FALSE,
                      warning    = FALSE,
                      results    = "asis")
```

```{r Load packages}
suppressPackageStartupMessages({
    library("cowplot")
    library("Seurat")
    library("tidyverse")
})
```

```{r Integrate datasets}
# Read filtered data
s_obj <- readRDS(params$input_seurat_object)

# Split data into each original sample
s_obj_list <- SplitObject(s_obj, split.by = "orig.ident")

# Define number of PCs and variable features
npcs <- 50
nfeatures <- 3000

# Normalise and find highest variable features per dataset
for (i in 1:length(s_obj_list)) {
    s_obj_list[[i]] <- NormalizeData(s_obj_list[[i]], verbose = FALSE)
    s_obj_list[[i]] <- FindVariableFeatures(s_obj_list[[i]],
                                              selection.method = "vst",
                                              nfeatures        = nfeatures,
                                              verbose          = FALSE)
}

# Find integration anchors
anchors <- FindIntegrationAnchors(object.list = s_obj_list,
                                  dims        = 1:npcs,
                                  reduction   = "cca")

# Integrate the samples with the identified anchors
s_obj_integrated <- IntegrateData(anchorset      = anchors,
                                  dims           = 1:npcs,
                                  new.assay.name = "CCA")
```

```{r Scaling and clustering}
# Run scaling, PCA and UMAP on data
s_obj_integrated <- ScaleData(s_obj_integrated, verbose = FALSE)
s_obj_integrated <- RunPCA(s_obj_integrated, npcs = npcs, verbose = FALSE)
s_obj_integrated <- RunUMAP(s_obj_integrated, dims = 1:npcs)
```

```{r Plot clusters and features}
# Plot integrated versus non-integrated clusters
plot_grid(ncol = 2,
    DimPlot(s_obj, reduction = "umap", group.by = "orig.ident") +
        NoAxes() +
        ggtitle("UMAP raw data"),
    DimPlot(s_obj_integrated, reduction = "umap", group.by = "orig.ident") +
        NoAxes() +
        ggtitle("UMAP integrated")
)

# Plot selected features on UMAP
features <- c("nCount_RNA", "nFeature_RNA", "percent_mito",
              "percent_ribo", "S.Score", "G2M.Score")
FeaturePlot(s_obj_integrated, reduction = "umap", features = features)
```

```{r Save RDS object}
saveRDS(s_obj_integrated, file = params$output_seurat_object)
```
