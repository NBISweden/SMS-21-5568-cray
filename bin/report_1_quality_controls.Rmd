---
params:
    root_directory: NULL
    input_seurat_object: NULL
    output_seurat_object: NULL
title: "NBIS Support #5568"
subtitle: "Quality controls and filtering"
author: "Erik Fasterius"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
    html_document:
        code_folding: hide
        toc: true
        toc_float:
            collapsed: true
---

```{r Setup}
# Knit options
knitr::opts_knit$set(root.dir = params$root_directory)

# Chunk options
knitr::opts_chunk$set(fig.width  = 12,
                      fig.height = 8,
                      fig.align  = "center",
                      message    = FALSE,
                      warning    = FALSE,
                      results    = "asis")
```

```{r Load packages}
suppressPackageStartupMessages({
    library("cowplot")
    library("tximport")
    library("Seurat")
    library("tidyverse")
})
```

```{r Read data}
s_obj <- readRDS(params$input_seurat_object)
```

# Unfiltered data

The following plots are performed on the raw, unfiltered expression data, with
the sole exception of reading in the data itself, which has been filtered to
exclude features (*i.e.* genes or transcripts, depending on the available
annotation) that are expressed in fewer than 3 cells, as well as excluding
cells which have fewer than 10 features.

## Quality controls

The genes used for cell cycle scoring are the default list of human genes.

```{r Normalisation and basic quality controls}
# Function for plotting basic QC metrics
plot_qc <- function(s_obj) {

    # Plot QC stats
    features <- c("nFeature_RNA", "nCount_RNA", "percent_mito", "percent_ribo",
                  "S.Score", "G2M.Score")
    VlnPlot(s_obj,
            group.by = "orig.ident",
            features = features,
            pt.size  = 0.1,
            ncol     = 2) +
        NoLegend()

    # Plot features vs. counts
    FeatureScatter(s_obj,
                   "nCount_RNA",
                   "nFeature_RNA",
                   group.by = "orig.ident",
                   pt.size  = 0.5) +
        theme(plot.title = element_text(hjust = 0.5)) +
        ggtitle("Counts vs. features")

    # Find and plot the top 20 highest variable features
    s_obj_tmp <- FindVariableFeatures(s_obj,
                                      selection.method = "vst",
                                      nfeatures        = 20)
    top_20 <- head(VariableFeatures(s_obj_tmp), 20)
    LabelPoints(plot   = VariableFeaturePlot(s_obj_tmp),
                points = top_20,
                repel  = TRUE) +
        theme(plot.title = element_text(hjust = 0.5)) +
        ggtitle("Top 20 variable features")
}

# Normalise data
s_obj <- NormalizeData(s_obj,
                       normalization.method = "LogNormalize",
                       scale.factor         = 10000)

# Add mitochondrial / ribosomal gene percentages
s_obj[["percent_mito"]] <- PercentageFeatureSet(s_obj, pattern = "^MT-")
s_obj[["percent_ribo"]] <- PercentageFeatureSet(s_obj, pattern = "^RP[SL]")

# Cell cycle scoring
s_obj <- CellCycleScoring(s_obj,
                          g2m.features = cc.genes$g2m.genes,
                          s.features   = cc.genes$s.genes)

# Plot QC metrics
plot_qc(s_obj)
```

## Clustering

```{r Variable genes, scaling and dimensionality reduction}
# Function for trying out different number of variable genes
dimensionality_reduction <- function(s_obj,
                                     nfeatures  = 3000,
                                     npcs       = 100,
                                     dims       = 1:50,
                                     resolution = 0.8) {

    # Find the highest variable features
    s_obj <- FindVariableFeatures(s_obj,
                                  selection.method = "vst",
                                  nfeatures        = nfeatures)

    # Scale data
    to_regress <- c("percent_mito", "nFeature_RNA", "S.Score", "G2M.Score")
    s_obj <- ScaleData(s_obj,
                       assay           = "RNA",
                       vars.to.regress = to_regress)

    # Dimensionality reduction and clustering
    s_obj <- RunPCA(s_obj,
                    npcs     = npcs,
                    features = VariableFeatures(object = s_obj))
    s_obj <- FindNeighbors(s_obj,
                           reduction = "pca",
                           dims      = dims,
                           verbose   = FALSE)
    s_obj <- FindClusters(s_obj,
                          reduction  = "pca",
                          resolution = resolution,
                          verbose    = FALSE)

    # Run and plot UMAP
    s_obj <- RunUMAP(s_obj,
                     dims                 = dims,
                     min.dist             = 0.01,
                     spread               = 0.3,
                     metric               = "cosine",
                     n.neighbors          = 15,
                     repulsion.strength   = 0.5,
                     negative.sample.rate = 20,
                     n.epochs             = 100,
                     verbose              = FALSE)
    gg1 <- DimPlot(s_obj, reduction = "umap", group.by = "orig.ident") +
        ggtitle("Samples")
    gg2 <- DimPlot(s_obj, reduction = "umap", group.by = "seurat_clusters") +
        ggtitle("Clusters")
    gg <- plot_grid(gg1, gg2, ncol = 1)
    show(gg)

    # Plot selected features on UMAP
    features <- c("nCount_RNA", "nFeature_RNA", "percent_mito",
                  "percent_ribo", "S.Score", "G2M.Score")
    gg <- FeaturePlot(s_obj, reduction = "umap", features = features)
    show(gg)
}

dimensionality_reduction(s_obj, nfeatures = 2000)
```

```{r Save to RDS}
save(s_obj, file = params$output_seurat_object)
```
